<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zea Kinematics - Setup Aim</title>
    <style type="text/css">
      html,
      body {
        overflow: hidden;
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="viewport"></div>
  </body>
  <script type="module">
    import {
      Vec3,
      Xfo,
      Ray,
      Color,
      Material,
      TreeItem,
      GeomItem,
      Cone,
      Sphere,
      Scene,
      GLRenderer,
    } from '../libs/zea-engine/dist/index.esm.js'
    import { AimOperator } from '../libs/zea-kinematics/dist/index.rawimport.js'

    const domElement = document.getElementById('viewport')

    const scene = new Scene()
    const renderer = new GLRenderer(domElement)
    renderer.setScene(scene)
    renderer.getViewport().getCamera().setPositionAndTarget(new Vec3(3, 3, 1), new Vec3(0, 0, 0))

    scene.setupGrid(10.0, 10)

    const treeItem = new TreeItem('tree')
    scene.getRoot().addChild(treeItem)

    const aimGeom = new Cone(0.2, 1.0, 30, true)
    const aimGeomMaterial = new Material('aimGeomMaterial', 'SimpleSurfaceShader')
    aimGeomMaterial.getParameter('BaseColor').setValue(new Color(1, 0, 0))
    const aimGeomItem = new GeomItem('aim', aimGeom, aimGeomMaterial)
    treeItem.addChild(aimGeomItem)

    const targGeom = new Sphere(0.04, 30)
    const targGeomMaterial = new Material('targGeomMaterial', 'SimpleSurfaceShader')
    targGeomMaterial.getParameter('BaseColor').setValue(new Color(0, 1, 0))
    const targGeomItem = new GeomItem('aim', targGeom, targGeomMaterial)
    const targXfo = new Xfo()
    targXfo.tr.set(-1, 1, 1)
    targGeomItem.getParameter('LocalXfo').setValue(targXfo)
    treeItem.addChild(targGeomItem)

    const aimOp = new AimOperator('AimOp')
    aimOp.getParameter('Axis').setValue(4)
    // aimOp.getParameter('Stretch').setValue(true)
    aimOp.getInput('Target').setParam(targGeomItem.getParameter('GlobalXfo'))
    aimOp.getOutput('InputOutput').setParam(aimGeomItem.getParameter('GlobalXfo'))
    treeItem.addChild(aimOp)

    // //////////////////////////////////////////////
    // Make the target draggable.
    targGeomItem.on('mouseEnter', (event) => {
      targGeomMaterial.getParameter('BaseColor').setValue(new Color(1, 1, 1))
    })
    targGeomItem.on('mouseLeave', (event) => {
      targGeomMaterial.getParameter('BaseColor').setValue(new Color(0, 1, 0))
    })

    let draggedGeom
    const geomRay = new Ray()
    const mouseMove = (event) => {
      event.stopPropagation()

      const xfo = draggedGeom.getParameter('GlobalXfo').getValue()
      const dist = event.mouseRay.intersectRayPlane(geomRay)
      xfo.tr = event.mouseRay.pointAtDist(dist)
      draggedGeom.getParameter('GlobalXfo').setValue(xfo)
    }
    const mouseUp = (event) => {
      event.stopPropagation()

      renderer.getViewport().off('mouseMove', mouseMove)
      renderer.getViewport().off('mouseUp', mouseUp)
    }
    renderer.getViewport().on('mouseDownOnGeom', (event) => {
      event.stopPropagation()

      draggedGeom = event.intersectionData.geomItem

      // geomRay.dir = event.viewport.getCamera().getParameter('GlobalXfo').getValue().ori.getZaxis().negate()
      geomRay.dir = event.mouseRay.dir.negate()
      geomRay.start = draggedGeom.getParameter('GlobalXfo').getValue().tr

      renderer.getViewport().on('mouseMove', mouseMove)
      renderer.getViewport().on('mouseUp', mouseUp)
    })
  </script>
</html>
